version: '3.8'

# ============================================================
# TMDB Movie Database - Docker Compose Configuration
# ============================================================
# This setup hosts both MariaDB and MongoDB locally
# All services communicate via Docker network using container names
# ============================================================

services:
  # ============================================================
  # MariaDB - SQL Database (Users, Movies, Ratings, Links)
  # ============================================================
  mariadb:
    image: mariadb:10.11
    container_name: movies_mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      MYSQL_DATABASE: movies_db
      MYSQL_USER: ${MYSQL_USER:-movies_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-movies_pass}
    ports:
      - "3306:3306"
    volumes:
      # Persist database data
      - mariadb_data:/var/lib/mysql
      # Custom configuration
      - ./docker/mariadb.cnf:/etc/mysql/conf.d/custom.cnf:ro
      # Initialize schema on first run
      - ./1_create_schema.sql:/docker-entrypoint-initdb.d/01_schema.sql:ro
    networks:
      - movies_network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================================
  # MongoDB - NoSQL Database (TMDB Metadata, Rich Movie Data)
  # ============================================================
  mongodb:
    image: mongo:7.0
    container_name: movies_mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-admin123}
      MONGO_INITDB_DATABASE: movies_nosql
    ports:
      - "27017:27017"
    volumes:
      # Persist database data
      - mongodb_data:/data/db
      # Initialize MongoDB on first run
      - ./docker/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      - movies_network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================================
  # Python Application Container (Optional - for Linux/Mac GUI)
  # ============================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: movies_app
    restart: unless-stopped
    depends_on:
      mariadb:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    environment:
      # MariaDB connection (use container name as host)
      DB_HOST: mariadb
      DB_USER: root
      DB_PASS: ${MYSQL_ROOT_PASSWORD:-123456}
      DB_NAME: movies_db
      # MongoDB connection (use container name as host)
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      MONGO_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_PASSWORD: ${MONGO_ROOT_PASSWORD:-admin123}
      MONGO_DB: movies_nosql
      MONGO_COLL: tmdb_movies
      # Use local MongoDB instead of Atlas
      USE_LOCAL_MONGO: "true"
      # Display for GUI (Linux/Mac X11)
      DISPLAY: ${DISPLAY:-:0}
    volumes:
      # Mount application files
      - .:/app
      # For X11 socket (Linux GUI support)
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    working_dir: /app
    stdin_open: true
    tty: true
    networks:
      - movies_network
    # Keep container running
    command: tail -f /dev/null

# ============================================================
# Docker Networks
# ============================================================
networks:
  movies_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================================
# Persistent Volumes
# ============================================================
volumes:
  mariadb_data:
    name: movies_mariadb_data
  mongodb_data:
    name: movies_mongodb_data
